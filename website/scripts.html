---
layout: default
---

<h2>Custom Scripts</h2>

<p>Several aspects of Cantaloupe offer the ability to use custom Ruby functions as "hooks" to provide dynamic information back to the image server. While the exact details of each function will vary, all scripts do have to obey some general rules.</p>

<h3>Naming</h3>

<p>Scripts can be named anything, but they must have a <span class="filename">.rb</span> extension. Then, they can be referenced in a configuration option by either their full absolute pathname, or their filename:</p>

<pre># Option 1: absolute pathname
some_key = /path/to/functions.rb

# Option 2: filename only; will be expected to be located in the
# same folder as the config file, or the current working directory
some_key = functions.rb</pre>

<p>A single <span class="filename">.rb</span> file can contain any number of functions. It is also fine to put each function in its own file.</p>

<h3>Example</h3>

<p>Here is an example of a script used by <a href="resolvers.html#FilesystemResolver">FilesystemResolver</a> that performs a Solr query to return a pathname based on an identifier. The documentation in that section describes the rules that this function must abide by &mdash; its name, parameters, and return value.</p>

<pre># functions.rb
require 'cgi'
require 'net/http'

def get_pathname(identifier)
  uri = 'http://localhost:8983/solr/collection1/select?q=' +
      CGI.escape('id:"' + identifier + '"') +
      '&amp;fl=pathname_si&amp;wt=ruby'
  uri = URI.parse(uri)

  http = Net::HTTP.new(uri.host, uri.port)
  request = Net::HTTP::Get.new(uri.request_uri)
  response = http.request(request)
  return nil if response.code.to_i >= 400

  results = eval(response.body)['response']['docs']
  results.any? ? results.first['pathname_si'] : nil
end

# Uncomment to test on the command line (`ruby functions.rb`)
# puts get_pathname('identifier-to-test')</pre>

<p>Inside a function, anything goes &mdash; it will be interpreted by a JRuby interpreter built into Cantaloupe, so you can even use any (non-platform-native) gems that you have installed with <code>gem install</code>. Because it will be called upon each image request, though, it should be written with efficiency in mind.</p>

<div class="alert alert-danger">Note: typically, neither function arguments nor return values are sanitized or validated. <strong>Be very careful to write defensive, injection-aware code.</strong></div>

<div class="alert alert-success">Note: scripts will be re-read on each request, so they can be edited without restarting.</div>
